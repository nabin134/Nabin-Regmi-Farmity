<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #358D58;
            --primary-dark: #2a6f45;
            --secondary: #F29900;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--secondary);
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .top-header {
            background: white;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }

        .dashboard-content {
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            font-size: 14px;
        }

        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .filter-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .users-table-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #eee;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .users-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #eee;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-badge.active { background: #d4edda; color: #155724; }
        .status-badge.inactive { background: #f8d7da; color: #721c24; }
        .status-badge.verified { background: #d1ecf1; color: #0c5460; }
        .status-badge.unverified { background: #fff3cd; color: #856404; }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .role-badge.farmer { background: #e7f3ff; color: #0066cc; }
        .role-badge.vendor { background: #fff4e6; color: #cc6600; }
        .role-badge.agricultural_expert { background: #e6f7ff; color: #0066cc; }
        .role-badge.buyer { background: #f0f0f0; color: #666; }
        .role-badge.admin { background: #ffe6e6; color: #cc0000; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-activate {
            background: var(--success);
            color: white;
        }

        .btn-deactivate {
            background: var(--warning);
            color: white;
        }

        .btn-block {
            background: var(--danger);
            color: white;
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-add {
            background: var(--success);
            color: white;
        }

        .btn-add:hover {
            background: #218838;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-seedling"></i>
            <h2>Farmity Admin</h2>
        </div>
        <nav class="sidebar-menu">
            <a href="{% url 'admin_dashboard' %}" class="menu-item">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="{% url 'admin_kyc_management' %}" class="menu-item">
                <i class="fas fa-id-card"></i>
                <span>KYC Management</span>
            </a>
            <a href="{% url 'admin_user_management' %}" class="menu-item active">
                <i class="fas fa-users"></i>
                <span>User Management</span>
            </a>
            <a href="{% url 'admin_content_management' %}" class="menu-item">
                <i class="fas fa-file-alt"></i>
                <span>Content Management</span>
            </a>
            <a href="{% url 'admin_marketplace_oversight' %}" class="menu-item">
                <i class="fas fa-store"></i>
                <span>Marketplace</span>
            </a>
            <a href="{% url 'admin_appointment_management' %}" class="menu-item">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </a>
            <a href="{% url 'admin_chat_reports' %}" class="menu-item">
                <i class="fas fa-comments"></i>
                <span>Chat & Reports</span>
            </a>
            <a href="{% url 'logout' %}" class="menu-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <header class="top-header">
            <h1 class="header-title">User Management</h1>
        </header>

        <div class="dashboard-content">
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 class="page-title">Platform Users</h2>
                        <p class="page-subtitle">Manage user accounts, activate, deactivate, or block users</p>
                    </div>
                    <button class="btn btn-add" onclick="openAddUserModal()" style="background: var(--success); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ total_users }}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ active_users }}</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ inactive_users }}</div>
                    <div class="stat-label">Inactive Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ verified_users }}</div>
                    <div class="stat-label">Verified Users</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-section">
                <form method="GET" action="{% url 'admin_user_management' %}">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Role</label>
                            <select name="role" class="filter-select">
                                <option value="all" {% if role_filter == 'all' %}selected{% endif %}>All Roles</option>
                                <option value="farmer" {% if role_filter == 'farmer' %}selected{% endif %}>Farmer</option>
                                <option value="vendor" {% if role_filter == 'vendor' %}selected{% endif %}>Vendor</option>
                                <option value="agricultural_expert" {% if role_filter == 'agricultural_expert' %}selected{% endif %}>Expert</option>
                                <option value="buyer" {% if role_filter == 'buyer' %}selected{% endif %}>Buyer</option>
                                <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select name="status" class="filter-select">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                                <option value="verified" {% if status_filter == 'verified' %}selected{% endif %}>Verified</option>
                                <option value="unverified" {% if status_filter == 'unverified' %}selected{% endif %}>Unverified</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Search</label>
                            <input type="text" name="search" class="filter-input" placeholder="Email or role" value="{{ search_query }}">
                        </div>
                        <div class="filter-group" style="justify-content: flex-end;">
                            <button type="submit" class="filter-btn">
                                <i class="fas fa-search"></i> Filter
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Users Table -->
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Verified</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.email }}</td>
                            <td>
                                <span class="role-badge {{ user.role }}">{{ user.get_role_display }}</span>
                            </td>
                            <td>
                                {% if user.is_active %}
                                <span class="status-badge active">Active</span>
                                {% else %}
                                <span class="status-badge inactive">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.is_verified %}
                                <span class="status-badge verified">Verified</span>
                                {% else %}
                                <span class="status-badge unverified">Unverified</span>
                                {% endif %}
                            </td>
                            <td>{{ user.date_joined|date:"M d, Y" }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-edit" onclick="openEditUserModal({{ user.id }}, '{{ user.email|escapejs }}', '{{ user.role }}', {{ user.is_active|yesno:"true,false" }}, {{ user.is_verified|yesno:"true,false" }})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    {% if user.id != request.user.id %}
                                    <button class="btn btn-delete" onclick="confirmDeleteUser({{ user.id }}, '{{ user.email|escapejs }}')" style="background: var(--danger); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    {% endif %}
                                    {% if user.is_active %}
                                    <button class="btn btn-deactivate" onclick="confirmAction({{ user.id }}, 'deactivate', '{{ user.email|escapejs }}')">
                                        <i class="fas fa-ban"></i> Deactivate
                                    </button>
                                    <button class="btn btn-block" onclick="confirmAction({{ user.id }}, 'block', '{{ user.email|escapejs }}')">
                                        <i class="fas fa-lock"></i> Block
                                    </button>
                                    {% else %}
                                    <button class="btn btn-activate" onclick="confirmAction({{ user.id }}, 'activate', '{{ user.email|escapejs }}')">
                                        <i class="fas fa-check"></i> Activate
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                No users found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="close-modal" onclick="closeAddUserModal()">&times;</button>
            </div>
            <form method="POST" action="{% url 'admin_user_management' %}" enctype="multipart/form-data" id="addUserForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_user">
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" name="email" id="addUserEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" name="password" id="addUserPassword" class="form-control" required minlength="8">
                    <small style="color: #666; font-size: 12px;">Minimum 8 characters</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select name="role" id="addUserRole" class="form-control" required>
                        <option value="buyer">Buyer</option>
                        <option value="farmer">Farmer</option>
                        <option value="vendor">Vendor</option>
                        <option value="agricultural_expert">Agricultural Expert</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="is_active" id="addUserActive" checked>
                        <span>Active</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="is_verified" id="addUserVerified">
                        <span>Verified</span>
                    </label>
                </div>
                
                <!-- Profile Fields (shown based on role) -->
                <div id="addProfileFieldsContainer" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 15px; font-size: 16px; font-weight: 600;">Profile Information</h4>
                    
                    <!-- Farmer Profile -->
                    <div id="addFarmerProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="profile_name" id="addFarmerName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" name="location" id="addFarmerLocation" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact</label>
                            <input type="text" name="contact" id="addFarmerContact" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Farm Size</label>
                            <input type="text" name="farm_size" id="addFarmerFarmSize" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Crop Types</label>
                            <textarea name="crop_types" id="addFarmerCropTypes" class="form-control" rows="2" placeholder="Comma-separated list"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Livestock Details</label>
                            <textarea name="livestock_details" id="addFarmerLivestock" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" name="photo" id="addFarmerPhoto" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Vendor Profile -->
                    <div id="addVendorProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" name="company_name" id="addVendorCompanyName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea name="address" id="addVendorAddress" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact</label>
                            <input type="text" name="contact" id="addVendorContact" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Logo</label>
                            <input type="file" name="logo" id="addVendorLogo" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Expert Profile -->
                    <div id="addExpertProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="profile_name" id="addExpertName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Qualification</label>
                            <input type="text" name="qualification" id="addExpertQualification" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Specialization</label>
                            <input type="text" name="specialization" id="addExpertSpecialization" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Experience</label>
                            <input type="text" name="experience" id="addExpertExperience" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" name="photo" id="addExpertPhoto" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Buyer Profile -->
                    <div id="addBuyerProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="profile_name" id="addBuyerName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea name="address" id="addBuyerAddress" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" name="phone" id="addBuyerPhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" name="photo" id="addBuyerPhoto" class="form-control" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeAddUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-add" style="background: var(--success); color: white;">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Edit User Details</h3>
                <button class="close-modal" onclick="closeEditUserModal()">&times;</button>
            </div>
            <form method="POST" action="{% url 'admin_user_management' %}" enctype="multipart/form-data" id="editUserForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_user">
                <input type="hidden" name="user_id" id="editUserId">
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" name="email" id="editUserEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select name="role" id="editUserRole" class="form-control" required>
                        <option value="buyer">Buyer</option>
                        <option value="farmer">Farmer</option>
                        <option value="vendor">Vendor</option>
                        <option value="agricultural_expert">Agricultural Expert</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="is_active" id="editUserActive">
                        <span>Active</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="is_verified" id="editUserVerified">
                        <span>Verified</span>
                    </label>
                </div>
                
                <!-- Profile Fields (shown based on role) -->
                <div id="profileFieldsContainer" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 15px; font-size: 16px; font-weight: 600;">Profile Information</h4>
                    
                    <!-- Farmer Profile -->
                    <div id="farmerProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="profile_name" id="farmerName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" name="location" id="farmerLocation" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact</label>
                            <input type="text" name="contact" id="farmerContact" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Farm Size</label>
                            <input type="text" name="farm_size" id="farmerFarmSize" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Crop Types</label>
                            <textarea name="crop_types" id="farmerCropTypes" class="form-control" rows="2" placeholder="Comma-separated list"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Livestock Details</label>
                            <textarea name="livestock_details" id="farmerLivestock" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" name="photo" id="farmerPhoto" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Vendor Profile -->
                    <div id="vendorProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" name="company_name" id="vendorCompanyName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea name="address" id="vendorAddress" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact</label>
                            <input type="text" name="contact" id="vendorContact" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Logo</label>
                            <input type="file" name="logo" id="vendorLogo" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Expert Profile -->
                    <div id="expertProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="profile_name" id="expertName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Qualification</label>
                            <input type="text" name="qualification" id="expertQualification" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Specialization</label>
                            <input type="text" name="specialization" id="expertSpecialization" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Experience</label>
                            <input type="text" name="experience" id="expertExperience" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" name="photo" id="expertPhoto" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Buyer Profile -->
                    <div id="buyerProfileFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" name="profile_name" id="buyerName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea name="address" id="buyerAddress" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" name="phone" id="buyerPhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <input type="file" name="photo" id="buyerPhoto" class="form-control" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeEditUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-edit">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Delete User</h3>
                <button class="close-modal" onclick="closeDeleteUserModal()">&times;</button>
            </div>
            <p id="deleteUserMessage"></p>
            <form method="POST" action="{% url 'admin_user_management' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="user_id" id="deleteUserId">
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeDeleteUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-delete" style="background: var(--danger); color: white;">Delete User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <p id="modalMessage"></p>
            <form method="POST" action="{% url 'admin_user_management' %}" id="actionForm">
                {% csrf_token %}
                <input type="hidden" name="user_id" id="actionUserId">
                <input type="hidden" name="action" id="actionType">
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal()" style="background: #6c757d; color: white;">Cancel</button>
                    <button type="submit" class="btn" id="confirmBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function confirmAction(userId, action, email) {
            const modal = document.getElementById('confirmModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const actionForm = document.getElementById('actionForm');
            const confirmBtn = document.getElementById('confirmBtn');
            
            document.getElementById('actionUserId').value = userId;
            document.getElementById('actionType').value = action;
            
            if (action === 'activate') {
                modalTitle.textContent = 'Activate User';
                modalMessage.textContent = `Are you sure you want to activate the user "${email}"?`;
                confirmBtn.textContent = 'Activate';
                confirmBtn.className = 'btn btn-activate';
            } else if (action === 'deactivate') {
                modalTitle.textContent = 'Deactivate User';
                modalMessage.textContent = `Are you sure you want to deactivate the user "${email}"?`;
                confirmBtn.textContent = 'Deactivate';
                confirmBtn.className = 'btn btn-deactivate';
            } else if (action === 'block') {
                modalTitle.textContent = 'Block User';
                modalMessage.textContent = `Are you sure you want to block the user "${email}"? This will deactivate their account.`;
                confirmBtn.textContent = 'Block';
                confirmBtn.className = 'btn btn-block';
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        // Edit User Modal Functions
        function openEditUserModal(userId, email, role, isActive, isVerified) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;
            document.getElementById('editUserActive').checked = isActive;
            document.getElementById('editUserVerified').checked = isVerified;
            
            // Hide all profile fields
            document.getElementById('farmerProfileFields').style.display = 'none';
            document.getElementById('vendorProfileFields').style.display = 'none';
            document.getElementById('expertProfileFields').style.display = 'none';
            document.getElementById('buyerProfileFields').style.display = 'none';
            
            // Show relevant profile fields based on role
            if (role === 'farmer') {
                document.getElementById('farmerProfileFields').style.display = 'block';
            } else if (role === 'vendor') {
                document.getElementById('vendorProfileFields').style.display = 'block';
            } else if (role === 'agricultural_expert') {
                document.getElementById('expertProfileFields').style.display = 'block';
            } else if (role === 'buyer') {
                document.getElementById('buyerProfileFields').style.display = 'block';
            }
            
            // Load profile data via AJAX
            fetch(`/admin-dashboard/users/view/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    if (role === 'farmer' && data.farmer_profile) {
                        document.getElementById('farmerName').value = data.farmer_profile.name || '';
                        document.getElementById('farmerLocation').value = data.farmer_profile.location || '';
                        document.getElementById('farmerContact').value = data.farmer_profile.contact || '';
                        document.getElementById('farmerFarmSize').value = data.farmer_profile.farm_size || '';
                        document.getElementById('farmerCropTypes').value = data.farmer_profile.crop_types || '';
                        document.getElementById('farmerLivestock').value = data.farmer_profile.livestock_details || '';
                    } else if (role === 'vendor' && data.vendor_profile) {
                        document.getElementById('vendorCompanyName').value = data.vendor_profile.company_name || '';
                        document.getElementById('vendorAddress').value = data.vendor_profile.address || '';
                        document.getElementById('vendorContact').value = data.vendor_profile.contact || '';
                    } else if (role === 'agricultural_expert' && data.expert_profile) {
                        document.getElementById('expertName').value = data.expert_profile.name || '';
                        document.getElementById('expertQualification').value = data.expert_profile.qualification || '';
                        document.getElementById('expertSpecialization').value = data.expert_profile.specialization || '';
                        document.getElementById('expertExperience').value = data.expert_profile.experience || '';
                    } else if (role === 'buyer' && data.user_profile) {
                        document.getElementById('buyerName').value = data.user_profile.name || '';
                        document.getElementById('buyerAddress').value = data.user_profile.address || '';
                        document.getElementById('buyerPhone').value = data.user_profile.phone || '';
                    }
                })
                .catch(error => {
                    console.log('Could not load profile data:', error);
                });
            
            // Update profile fields visibility when role changes
            document.getElementById('editUserRole').addEventListener('change', function() {
                const selectedRole = this.value;
                document.getElementById('farmerProfileFields').style.display = 'none';
                document.getElementById('vendorProfileFields').style.display = 'none';
                document.getElementById('expertProfileFields').style.display = 'none';
                document.getElementById('buyerProfileFields').style.display = 'none';
                
                if (selectedRole === 'farmer') {
                    document.getElementById('farmerProfileFields').style.display = 'block';
                } else if (selectedRole === 'vendor') {
                    document.getElementById('vendorProfileFields').style.display = 'block';
                } else if (selectedRole === 'agricultural_expert') {
                    document.getElementById('expertProfileFields').style.display = 'block';
                } else if (selectedRole === 'buyer') {
                    document.getElementById('buyerProfileFields').style.display = 'block';
                }
            });
            
            document.getElementById('editUserModal').classList.add('active');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('active');
        }

        // Add User Modal Functions
        function openAddUserModal() {
            // Reset form
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserActive').checked = true;
            document.getElementById('addUserVerified').checked = false;
            
            // Hide all profile fields
            document.getElementById('addFarmerProfileFields').style.display = 'none';
            document.getElementById('addVendorProfileFields').style.display = 'none';
            document.getElementById('addExpertProfileFields').style.display = 'none';
            document.getElementById('addBuyerProfileFields').style.display = 'none';
            
            // Show buyer profile by default
            document.getElementById('addBuyerProfileFields').style.display = 'block';
            
            // Update profile fields visibility when role changes
            const roleSelect = document.getElementById('addUserRole');
            roleSelect.onchange = function() {
                const selectedRole = this.value;
                document.getElementById('addFarmerProfileFields').style.display = 'none';
                document.getElementById('addVendorProfileFields').style.display = 'none';
                document.getElementById('addExpertProfileFields').style.display = 'none';
                document.getElementById('addBuyerProfileFields').style.display = 'none';
                
                if (selectedRole === 'farmer') {
                    document.getElementById('addFarmerProfileFields').style.display = 'block';
                } else if (selectedRole === 'vendor') {
                    document.getElementById('addVendorProfileFields').style.display = 'block';
                } else if (selectedRole === 'agricultural_expert') {
                    document.getElementById('addExpertProfileFields').style.display = 'block';
                } else if (selectedRole === 'buyer') {
                    document.getElementById('addBuyerProfileFields').style.display = 'block';
                }
            };
            
            document.getElementById('addUserModal').classList.add('active');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
        }

        // Delete User Functions
        function confirmDeleteUser(userId, email) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserMessage').textContent = `Are you sure you want to delete the user "${email}"? This action cannot be undone and will delete all associated data.`;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').classList.remove('active');
        }

        window.onclick = function(event) {
            const modals = ['confirmModal', 'editUserModal', 'addUserModal', 'deleteUserModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    if (modalId === 'confirmModal') {
                        closeModal();
                    } else if (modalId === 'editUserModal') {
                        closeEditUserModal();
                    } else if (modalId === 'addUserModal') {
                        closeAddUserModal();
                    } else if (modalId === 'deleteUserModal') {
                        closeDeleteUserModal();
                    }
                }
            });
        }
    </script>
</body>
</html>
